---
layout: post
title: 微信公众平台消息应答PHP后台设计
category: Weixin
tags: PHP 中文
date: 2016-02-27
---

从个人的角度来看，微信由三部分组成，首先当然是IM（即时聊天）工具，其次是CLI（命令行接口），最后是Web Browser（网页浏览器）。
<!--more-->

## 谈谈微信组成
当然，从一定层面上看，微信将这三者结合的很成功。利用免费的IM具备强大的用户群，然后通过做平台营收。

前一篇文章，讲到关于微信浏览器的部分，今天就抽时间还是来写写关于命令行接口的部分。虽然，写东西的确是挺耗费时间的事情，不过写写既是分享，也是总结吧。

微信的公众平台是可以被看作命令行接口的，理由是和传统的命令行工具一样，提供一个输入，然后可以反馈输出。只不过，微信的命令行更图形化简单化，所以普通用户的接受程度会高不少。

## 问题背景
从昨天下午开始，到今天吃晚餐，就一直在开发自己的公众平台。折腾了一整天，总算在后台将基本功能实现同时也把代码从逻辑上整理清楚了，就看以后有时间慢慢去写插件了。

有兴趣的朋友可以扫码以下二维码关注下
![中文学习](/assets/images/wx-api/zwxx.jpg)  

因为不是太喜欢被微信素材管理相关的条条框框约束，另外也是因为个人未认证的的公众号权限非常有限，所以在选择实现的时候，就主要选择了能够帮助导流的微信公众平台功能。

了解微信公众平台的朋友知道，公众平台主动发消息给用户是不能推送外链的，而素材管理里面的页面既不能添加```<a href="">链接上的文字</a>```元素（对普通的公众平台账号是这样的），又不能植入JavaScript代码，所以我的策略就是推送给用户文章信息，提示关键字的同时，添加可以访问的链接（在文本消息中可以使用```<a href="">链接上的文字</a>```元素），有兴趣的朋友可以查看历史消息中今天推送的文字信息。

## 微信命令行接口实现逻辑
引导了用户发起请求，也就是告诉了用户可以向命令行接口输入命令（当然，这种简化命令可以是关键字，或者关键字＋空格＋参数）。

有了用户输入，然后就是后台应该怎样处理用户输入并给予反馈了。微信允许的被动回复消息分为六种，然而其中“图片消息”、“语言消息”、“视频消息”都必须使用有MediaId的素材，也就是说必须将素材托管到受限平台，所以我便只选择了其它另外三种消息，即“文本消息”（幸运的是可以带链接），“音乐消息”和“图文消息”。讲到这里，也就是说，对于微信命令行接口，作为开发者，我们可以返回三种类型的输出。

有了允许输出类型，然后就是决定利用这三种输出的组合构建公众平台的功能。在我以上二维码对应的公众平台“中文学习(zhongwenxuexi)”中，我实现了以下功能如图（感兴趣的朋友可以自己玩玩儿）。

![中文学习功能图](/assets/images/wx-api/wxutilities.png)  

当然，事实上以上图中的“天气 上海”和“背单词”功能还在计划中没有实现。放在上面为了叙述功能和传统命令行工具对比。

图中，上面四个功能和下面两个功能从逻辑上讲并不是同一个层次的。一种理解可以是，“文章”，“音乐”，“段子”几个命令就相当于OS X终端里面的`pwd`命令，“天气 上海”就相当于`cd Desktop`命令；而下面的“聊天”或者”背单词“命令就相当于OS X终端里面的`python`命令，将会开启一个新的执行环境。说到这里，估计机智的小伙伴也知道我在讲什么了。不机智的小伙伴，估计也不用我再讲了。

最后，谈谈如何实现以上功能的问题。恰好昨天看完了[《深入PHP：面向对象、模式与实践（第3版）》](/Agoing.html#php3httpsbookdoubancomsubject6559267)中的第4章，所以就将所有需要用到的公众平台消息模版放到了一个静态类中，然后在接口脚本中调用消息模版中的诸如`::renderText()`,`::renderImage()`,`::renderMusic`的方法。然后在调用之前又一个问题就是，数据从哪儿来？

关于数据从哪儿来的问题，针对于当前中文学习微信公众平台的几个功能，我分别采用了一个接口（API）脚本。将“文章”关键词，交由`getNew()`函数从`articles.php`接口脚本中获取回复数据，然后用模版方法包装然后返回，对于“音乐”、“段子”同样自己实现另外两个接口脚本。因为“聊天”这个功能比较庞大，短时间类一个人几乎是不可能完成，所以这里的实现逻辑就是，将进入“聊天”模式后的所有消息，解析后再调用“图灵机器人api”获取回应消息，然后用模版包装了返回。

## 题外话
文字描述的比较抽象，不过需要明白的人，或者内行应该很容易看懂。毕竟这里主要谈逻辑结构，算是思想层面的吧。并且无论如何也不是空想吧，毕竟我可是亲自实现了的。

先写这么多吧，最近开学了然后还要找工作，没有太多时间整理。


